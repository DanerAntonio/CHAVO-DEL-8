<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Teo/Cat</title>


    <link rel="shortcut icon" type="image/png" href="../assets/images/logos/favicon.jpeg" />
    <link rel="stylesheet" href="../assets/css/styles.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/themify-icons/0.1.2/css/themify-icons.min.css">
    <link rel="stylesheet" href="../Css/GdeCategoria.css">
</head>

<body>
    <!--  Body Wrapper -->
    <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
        data-sidebar-position="fixed" data-header-position="fixed">
        <!-- Sidebar Start -->
        <aside class="left-sidebar">
            <!-- Sidebar scroll-->
            <div>
                <div class="brand-logo d-flex align-items-center justify-content-between">
                    <a href="./index.html" class="text-nowrap logo-img">
                        <img src="../assets/images/logos/1.png" width="180" alt="" />
                    </a>
                    <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
                        <i class="ti ti-x fs-8"></i>
                    </div>
                </div>
                <!-- Sidebar navigation-->
                <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
                    <ul id="sidebarnav">
                        <li class="nav-small-cap">
                            <i class="ti ti-menu-2 nav-small-cap-icon fs-4"></i>
                            <span class="hide-menu">Menu Principal</span>
                        </li>

                        <li class="sidebar-item">
                            <a class="sidebar-link" href="index.html">
                                <span>
                                    <i class="ti ti-home"></i>
                                </span>
                                <span class="hide-menu">Inicio</span>
                            </a>
                        </li>
                        <li>
                            <hr />
                        </li>

                        <!-- Dashboard -->
                        <li class="sidebar-item">
                            <a class="sidebar-link has-arrow" href="#dashboardSubmenu" data-bs-toggle="collapse"
                                aria-expanded="false">
                                <span>
                                    <i class="ti ti-dashboard"></i>
                                </span>
                                <span class="hide-menu">Dashboard</span>
                            </a>
                            <ul id="dashboardSubmenu" class="collapse first-level">
                                <li class="sidebar-item">
                                    <a href="GestionDesempeno.html" class="sidebar-link">
                                        <i class="ti ti-chart-bar"></i>
                                        <span class="hide-menu">Gestión De Desempeño</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <hr />
                        </li>

                        <!-- Configuración -->
                        <li class="sidebar-item">
                            <a class="sidebar-link has-arrow" href="#configSubmenu" data-bs-toggle="collapse"
                                aria-expanded="false">
                                <span>
                                    <i class="ti ti-settings"></i>
                                </span>
                                <span class="hide-menu">Configuración</span>
                            </a>
                            <ul id="configSubmenu" class="collapse first-level">
                                <li class="sidebar-item">
                                    <a href="GestiónDeRoles.html" class="sidebar-link">
                                        <i class="ti ti-user-check"></i>
                                        <span class="hide-menu">Gestión De Roles</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <hr />
                        </li>

                        <!-- Usuarios -->
                        <li class="sidebar-item">
                            <a class="sidebar-link has-arrow" href="#userSubmenu" data-bs-toggle="collapse"
                                aria-expanded="false">
                                <span>
                                    <i class="ti ti-users"></i>
                                </span>
                                <span class="hide-menu">Usuarios</span>
                            </a>
                            <ul id="userSubmenu" class="collapse first-level">
                                <li class="sidebar-item">
                                    <a href="GestiónDeUsuarios.html" class="sidebar-link">
                                        <i class="ti ti-user-plus"></i>
                                        <span class="hide-menu">Gestión De Usuarios</span>
                                    </a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="GestiónDeAcceso.html" class="sidebar-link">
                                        <i class="ti ti-lock"></i>
                                        <span class="hide-menu">Gestión De Acceso</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <hr />
                        </li>

                        <!-- Categorías -->
                        <li class="sidebar-item">
                            <a class="sidebar-link has-arrow" href="#categoriasSubmenu" data-bs-toggle="collapse"
                                aria-expanded="false">
                                <span>
                                    <i class="ti ti-category"></i>
                                </span>
                                <span class="hide-menu">Categorías</span>
                            </a>
                            <ul id="categoriasSubmenu" class="collapse first-level">
                                <li class="sidebar-item">
                                    <a href="CategoriasProductos.html" class="sidebar-link">
                                        <i class="ti ti-box"></i>
                                        <span class="hide-menu">Categorías De Productos</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <hr />
                        </li>

                        <!-- Compras -->
                        <li class="sidebar-item">
                            <a class="sidebar-link has-arrow" href="#comprasSubmenu" data-bs-toggle="collapse"
                                aria-expanded="false">
                                <span>
                                    <i class="ti ti-shopping-cart"></i>
                                </span>
                                <span class="hide-menu">Compras</span>
                            </a>
                            <ul id="comprasSubmenu" class="collapse first-level">
                                <li class="sidebar-item">
                                    <a href="GDeProductos.html" class="sidebar-link">
                                        <i class="ti ti-package"></i>
                                        <span class="hide-menu">Gestión De Productos</span>
                                    </a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="GDeProveedores.html" class="sidebar-link">
                                        <i class="ti ti-truck-delivery"></i>
                                        <span class="hide-menu">Gestión De Proveedores</span>
                                    </a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="GDeCompras.html" class="sidebar-link">
                                        <i class="ti ti-receipt"></i>
                                        <span class="hide-menu">Gestión De Compras</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <hr />
                        </li>

                        <!-- Ventas -->
                        <li class="sidebar-item">
                            <a class="sidebar-link has-arrow" href="#ventasSubmenu" data-bs-toggle="collapse"
                                aria-expanded="false">
                                <span>
                                    <i class="ti ti-cash"></i>
                                </span>
                                <span class="hide-menu">Ventas</span>
                            </a>
                            <ul id="ventasSubmenu" class="collapse first-level">
                                <li class="sidebar-item">
                                    <a href="GDeClientes.html" class="sidebar-link">
                                        <i class="ti ti-user-circle"></i>
                                        <span class="hide-menu">Gestión De Clientes</span>
                                    </a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="GDePedidos.html" class="sidebar-link">
                                        <i class="ti ti-clipboard-list"></i>
                                        <span class="hide-menu">Gestión De Pedidos</span>
                                    </a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="GDeVentas.html" class="sidebar-link">
                                        <i class="ti ti-report-money"></i>
                                        <span class="hide-menu">Gestión De Ventas</span>
                                    </a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="GDeDevoluciones2.html" class="sidebar-link">
                                        <i class="ti ti-arrow-back-up"></i>
                                        <span class="hide-menu">Devoluciones</span>
                                    </a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="GDeDevoluciones2.html" class="sidebar-link">
                                        <i class="ti ti-exchange"></i>
                                        <span class="hide-menu">Devoluciones2</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </nav>
                <!-- End Sidebar navigation -->
            </div>
            <!-- End Sidebar scroll-->
        </aside>
        <!--  Sidebar End -->
        <!--  Main wrapper -->
        <div class="body-wrapper">

            <!--  Header Start -->
            <header class="app-header">
                <nav class="navbar navbar-expand-lg navbar-light">
                    <ul class="navbar-nav">
                        <li class="nav-item d-block d-xl-none">
                            <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse"
                                href="javascript:void(0)">
                                <i class="ti ti-menu-2"></i>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link nav-icon-hover" href="javascript:void(0)">
                                <i class="ti ti-bell-ringing"></i>
                                <div class="notification bg-primary rounded-circle"></div>
                            </a>
                        </li>
                    </ul>
                    <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
                        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">

                            <!-- Carrito de compras -->
                            <li class="nav-item">
                                <a class="nav-link nav-icon-hover" href="Carrito.html">
                                    <i class="ti ti-shopping-cart"></i>
                                </a>
                            </li>

                            <!-- Perfil de usuario -->
                            <li class="nav-item dropdown">
                                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="../assets/images/profile/user-1.jpg" alt="" width="35" height="35"
                                        class="rounded-circle">
                                </a>
                                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up"
                                    aria-labelledby="drop2">
                                    <div class="message-body">
                                        <a href="MiPerfil.html" class="d-flex align-items-center gap-2 dropdown-item">
                                            <i class="ti ti-user fs-6"></i>
                                            <p class="mb-0 fs-3">Mi Perfil</p>
                                        </a>
                                        <a href="Login.html" class="btn btn-outline-primary mx-3 mt-2 d-block">Cerrar
                                            Sesion</a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </header>
            <!--  Header End -->

            <div class="container-fluid"></div>
    <div class="container">
        <h2 class="text-center mt-4">Gestión de Productos</h2>

        <!-- Buscador de Producto -->
        <div class="d-flex justify-content-between mb-3">
            <div class="input-group w-75">
                <input type="text" id="buscar" class="form-control" placeholder="Buscar producto por nombre">
                <button class="btn btn-outline-secondary" type="button" onclick="buscarProducto()">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <button class="btn btn-success" onclick="agregarProducto()">Agregar Producto</button>
        </div>

        <!-- Tabla de Productos -->
        <div class="table-responsive">
            <table class="table table-striped" id="tabla-productos">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Categoría</th>
                        <th>Stock</th>
                        <th>Precio</th>
                        <th>Fecha Vencimiento</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se insertarán los productos dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let categorias = [];

        // Cargar productos y categorías desde la API cuando la página cargue
        document.addEventListener('DOMContentLoaded', () => {
            cargarCategorias().then(() => cargarProductos());
        });

        // Función para cargar categorías
        async function cargarCategorias() {
            try {
                const response = await fetch('https://chavo-del-8.onrender.com/Api/CategoriaProducto');
                categorias = await response.json();
            } catch (error) {
                console.error('Error al cargar las categorías:', error);
            }
        }

        // Función para cargar productos desde la API
        function cargarProductos() {
            fetch('https://chavo-del-8.onrender.com/Api/Producto')
                .then(response => response.json())
                .then(data => {
                    let tbody = document.querySelector('#tabla-productos tbody');
                    tbody.innerHTML = ''; // Limpiar tabla antes de agregar los productos

                    data.forEach(producto => {
                        let fila = `
                            <tr>
                                <td>${producto._id}</td>
                                <td>${producto.nombre}</td>
                                <td>${producto.descripcion}</td>
                                <td>${producto.id_categoria ? producto.id_categoria.nombre : 'N/A'}</td>
                                <td>${producto.stock}</td>
                                <td>${producto.precio}</td>
                                <td>${new Date(producto.fecha_vencimiento).toLocaleDateString()}</td>
                                <td>${producto.estado}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="editarProducto('${producto._id}')">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="eliminarProducto('${producto._id}')">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += fila;
                    });
                })
                .catch(error => console.error('Error al cargar los productos:', error));
        }

        // Función para buscar producto en la tabla
        function buscarProducto() {
            let input = document.getElementById('buscar').value.toLowerCase();
            let rows = document.querySelectorAll('#tabla-productos tbody tr');
            
            rows.forEach(row => {
                let nombre = row.querySelector('td:nth-child(2)').innerText.toLowerCase();
                row.style.display = nombre.includes(input) ? '' : 'none';
            });
        }

        // Función para agregar un nuevo producto
        function agregarProducto() {
            let categoriasOptions = categorias.map(cat => `<option value="${cat._id}">${cat.nombre}</option>`).join('');
            
            Swal.fire({
                title: 'Agregar nuevo producto',
                html:
                    '<select id="id_categoria" class="swal2-input">' +
                    '<option value="">Seleccione una categoría</option>' +
                    categoriasOptions +
                    '</select>' +
                    '<input id="nombre" class="swal2-input" placeholder="Nombre del producto">' +
                    '<input id="descripcion" class="swal2-input" placeholder="Descripción">' +
                    '<input id="fecha_vencimiento" class="swal2-input" type="date" placeholder="Fecha de vencimiento">' +
                    '<input id="stock" class="swal2-input" type="number" placeholder="Stock">' +
                    '<input id="precio" class="swal2-input" type="number" step="0.01" placeholder="Precio">' +
                    '<select id="estado" class="swal2-input">' +
                    '<option value="activo">Activo</option>' +
                    '<option value="inactivo">Inactivo</option>' +
                    '</select>',
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                preConfirm: () => {
                    let id_categoria = document.getElementById('id_categoria').value;
                    let nombre = document.getElementById('nombre').value;
                    let descripcion = document.getElementById('descripcion').value;
                    let fecha_vencimiento = document.getElementById('fecha_vencimiento').value;
                    let stock = document.getElementById('stock').value;
                    let precio = document.getElementById('precio').value;
                    let estado = document.getElementById('estado').value;

                    if (!id_categoria || !nombre || !descripcion || !fecha_vencimiento || !stock || !precio) {
                        Swal.showValidationMessage('Por favor, complete todos los campos.');
                        return false;
                    }

                    // Agregar producto a la base de datos
                    fetch('https://chavo-del-8.onrender.com/Api/Producto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id_categoria: id_categoria,
                            nombre: nombre,
                            descripcion: descripcion,
                            fecha_vencimiento: fecha_vencimiento,
                            stock: parseInt(stock),
                            precio: parseFloat(precio),
                            estado: estado
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        Swal.fire('Éxito', 'Producto agregado correctamente', 'success');
                        cargarProductos(); // Recargar la tabla de productos
                    })
                    .catch(error => Swal.fire('Error', 'No se pudo agregar el producto', 'error'));
                }
            });
        }

        // Función para editar un producto
        function editarProducto(id) {
            // Obtener los datos del producto a editar
            fetch(`https://chavo-del-8.onrender.com/Api/Producto/${id}`)
                .then(response => response.json())
                .then(producto => {
                    let categoriasOptions = categorias.map(cat => 
                        `<option value="${cat._id}" ${cat._id === producto.id_categoria._id ? 'selected' : ''}>${cat.nombre}</option>`
                    ).join('');

                    Swal.fire({
                        title: 'Editar producto',
                        html:
                            '<select id="id_categoria" class="swal2-input">' +
                            '<option value="">Seleccione una categoría</option>' +
                            categoriasOptions +
                            '</select>' +
                            `<input id="nombre" class="swal2-input" value="${producto.nombre}">` +
                            `<input id="descripcion" class="swal2-input" value="${producto.descripcion}">` +
                            `<input id="fecha_vencimiento" class="swal2-input" type="date" value="${producto.fecha_vencimiento.split('T')[0]}">` +
                            `<input id="stock" class="swal2-input" type="number" value="${producto.stock}">` +
                            `<input id="precio" class="swal2-input" type="number" step="0.01" value="${producto.precio}">` +
                            '<select id="estado" class="swal2-input">' +
                            `<option value="activo" ${producto.estado === 'activo' ? 'selected' : ''}>Activo</option>` +
                            `<option value="inactivo" ${producto.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>` +
                            '</select>',
                        showCancelButton: true,
                        confirmButtonText: 'Actualizar',
                        preConfirm: () => {
                            let id_categoria = document.getElementById('id_categoria').value;
                            let nombre = document.getElementById('nombre').value;
                            let descripcion = document.getElementById('descripcion').value;
                            let fecha_vencimiento = document.getElementById('fecha_vencimiento').value;
                            let stock = document.getElementById('stock').value;
                            let precio = document.getElementById('precio').value;
                            let estado = document.getElementById('estado').value;

                            if (!id_categoria || !nombre || !descripcion || !fecha_vencimiento || !stock || !precio) {
                                Swal.showValidationMessage('Todos los campos son obligatorios.');
                                return false;
                            }

                            // Actualizar el producto
                            fetch(`https://chavo-del-8.onrender.com/Api/Producto/${id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    id_categoria: id_categoria,
                                    nombre: nombre,
                                    descripcion: descripcion,
                                    fecha_vencimiento: fecha_vencimiento,
                                    stock: parseInt(stock),
                                    precio: parseFloat(precio),
                                    estado: estado
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                Swal.fire('Actualizado', 'Producto actualizado correctamente', 'success');
                                cargarProductos(); // Recargar la lista de productos
                            })
                            .catch(error => Swal.fire('Error', 'No se pudo actualizar el producto', 'error'));
                        }
                    });
                })
                .catch(error => Swal.fire('Error', 'No se pudo obtener el producto', 'error'));
        }

        // Función para eliminar un producto
        function eliminarProducto(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esto",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Eliminar producto
                    fetch(`https://chavo-del-8.onrender.com/Api/Producto/${id}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        Swal.fire('Eliminado', 'Producto eliminado correctamente', 'success');
                        cargarProductos(); // Recargar la lista de productos
                    })
                    .catch(error => Swal.fire('Error', 'No se pudo eliminar el producto', 'error'));
                }
            });
        }
    </script>
</body>
</html>